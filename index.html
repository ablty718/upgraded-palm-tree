<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ANT·ON – Product Search (Web)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Smooth collapse animation */
    .collapse { max-height: 0; overflow: hidden; transition: max-height .25s ease; }
    .collapse.open { max-height: 1200px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <!-- Top Bar -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center gap-3">
      <!-- Tiny wordmark logo -->
      <div class="w-8 h-8 rounded-xl bg-slate-900 text-white grid place-items-center text-xs font-semibold select-none">A</div>
      <div class="text-lg font-semibold tracking-tight">ANT·ON <span class="font-normal text-slate-500">— Web Search</span></div>
      <div class="ml-auto text-xs text-slate-500">Press <kbd class="px-1 py-0.5 border rounded">Enter</kbd> to search</div>
    </div>
  </header>

  <!-- Search + Filters -->
  <main class="mx-auto max-w-6xl px-4 py-6">
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 md:p-5">
      <div class="flex flex-col gap-3 md:flex-row md:items-center">
        <div class="flex-1">
          <label for="q" class="sr-only">Search</label>
          <input id="q" type="search" placeholder="Search products (style #, keywords, color, etc.)" class="w-full rounded-xl border border-slate-300 px-4 py-3 focus:outline-none focus:ring-4 focus:ring-sky-100 focus:border-sky-400" />
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="chk-ssaw" type="checkbox" class="rounded border-slate-300" checked />
            <span>SS Activewear</span>
          </label>
          <label class="inline-flex items-center gap-2 text-sm">
            <input id="chk-sanmar" type="checkbox" class="rounded border-slate-300" checked />
            <span>SanMar</span>
          </label>
          <div class="hidden md:block w-px h-6 bg-slate-200"></div>
          <input id="brand" type="text" placeholder="Brand (optional)" class="w-[160px] rounded-lg border border-slate-300 px-3 py-2" />
          <input id="color" type="text" placeholder="Color (optional)" class="w-[160px] rounded-lg border border-slate-300 px-3 py-2" />
        </div>
      </div>
    </section>

    <!-- Status Row -->
    <section id="status-row" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
      <div id="status-ssaw" class="hidden md:block rounded-xl border p-3 text-sm"></div>
      <div id="status-sanmar" class="hidden md:block rounded-xl border p-3 text-sm"></div>
      <div id="status-summary" class="rounded-xl border p-3 text-sm"></div>
    </section>

    <!-- Results -->
    <section class="mt-5">
      <div id="results" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      <div id="empty" class="hidden text-center text-slate-500 py-12">Start typing above and hit Enter to search both suppliers.</div>
    </section>
  </main>

  <template id="card-tpl">
    <div class="group bg-white border border-slate-200 rounded-2xl overflow-hidden shadow-sm hover:shadow transition">
      <div class="aspect-[4/3] bg-slate-100 grid place-items-center overflow-hidden">
        <img class="h-full w-full object-contain" alt="Product image" />
      </div>
      <div class="p-4">
        <div class="flex items-start gap-2">
          <div class="text-[10px] uppercase tracking-wide font-semibold px-2 py-1 rounded-full bg-slate-900 text-white" data-source></div>
          <div class="ml-auto text-xs text-slate-500" data-style></div>
        </div>
        <h3 class="mt-2 font-semibold leading-tight line-clamp-2" data-name></h3>
        <div class="mt-1 text-sm text-slate-600" data-brand></div>
        <div class="mt-2 flex items-center justify-between">
          <div class="text-sm"><span class="font-medium">Qty:</span> <span data-qty>—</span></div>
          <button class="text-sm underline underline-offset-4 hover:no-underline" data-toggle>Details</button>
        </div>
      </div>
      <div class="collapse" data-details>
        <div class="p-4 border-t bg-slate-50">
          <dl class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
            <dt class="text-slate-500">Color</dt><dd data-color class="font-medium">—</dd>
            <dt class="text-slate-500">Price</dt><dd data-price class="font-medium">—</dd>
            <dt class="text-slate-500">SKU/ID</dt><dd data-id class="font-medium">—</dd>
          </dl>
          <details class="mt-3">
            <summary class="text-xs text-slate-500 cursor-pointer">Debug payload</summary>
            <pre class="mt-2 text-[11px] whitespace-pre-wrap" data-debug></pre>
          </details>
        </div>
      </div>
    </div>
  </template>

  <script type="module">
    // --- Configuration -------------------------------------------------------
    const CONFIG = {
      // If hosting this HTML somewhere else, set BASE_URL to your API host.
      // Example: 'https://supreme-dollop-t443.vercel.app' (no trailing slash)
      BASE_URL: location.origin,
      ENDPOINTS: {
        ssaw: '/api/ssaw',     // REST proxy you already built
        sanmar: '/api/sanmar', // SOAP→JSON proxy endpoint you built
      },
      PAGE_SIZE: 40,
    };

    // --- DOM references ------------------------------------------------------
    const elQ = document.querySelector('#q');
    const elBrand = document.querySelector('#brand');
    const elColor = document.querySelector('#color');
    const elChkSSAW = document.querySelector('#chk-ssaw');
    const elChkSanmar = document.querySelector('#chk-sanmar');
    const elResults = document.querySelector('#results');
    const elEmpty = document.querySelector('#empty');

    const elStatusSSAW = document.querySelector('#status-ssaw');
    const elStatusSanmar = document.querySelector('#status-sanmar');
    const elStatusSummary = document.querySelector('#status-summary');

    // --- Utilities -----------------------------------------------------------
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmtInt = (n) => Number.isFinite(n) ? new Intl.NumberFormat().format(n) : '—';

    function safe(obj, ...keys) {
      // Try a list of key paths, return first non-empty
      for (const path of keys) {
        let val = obj;
        for (const part of path.split('.')) {
          if (val && typeof val === 'object' && part in val) val = val[part]; else { val = undefined; break; }
        }
        if (val !== undefined && val !== null && val !== '') return val;
      }
      return undefined;
    }

    function imgOrPlaceholder(src) {
      if (!src) return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600"><rect width="100%" height="100%" fill="#eef2f7"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto" font-size="20" fill="#94a3b8">No image</text></svg>`);
      return src;
    }

    // Heuristic: pick quantity from various shapes
    function pickQty(p) {
      const direct = ['qty', 'Qty', 'onHand', 'OnHand', 'quantity', 'Quantity'].map(k => p?.[k]).find(v => Number.isFinite(Number(v)));
      if (Number.isFinite(Number(direct))) return Number(direct);
      // Sum variants if present (SSAW often nests qty per size/color)
      const variants = safe(p, 'variants', 'Variants', 'sizes', 'Sizes', 'sizeList', 'SizeList');
      if (Array.isArray(variants)) {
        let sum = 0; let found = false;
        for (const v of variants) {
          const q = ['qty', 'Qty', 'onHand', 'OnHand', 'available', 'Available'].map(k => v?.[k]).find(vv => Number.isFinite(Number(vv)));
          if (Number.isFinite(Number(q))) { sum += Number(q); found = true; }
        }
        if (found) return sum;
      }
      // Warehouse inventories array
      const inv = safe(p, 'inventory', 'Inventory', 'warehouses', 'Warehouses', 'warehouseInventories');
      if (Array.isArray(inv)) {
        let sum = 0; let found = false;
        for (const w of inv) {
          const q = ['qty', 'Qty', 'onHand', 'OnHand', 'available', 'Available'].map(k => w?.[k]).find(vv => Number.isFinite(Number(vv)));
          if (Number.isFinite(Number(q))) { sum += Number(q); found = true; }
        }
        if (found) return sum;
      }
      return undefined;
    }

    // --- Provider: SS Activewear (REST) -------------------------------------
    async function searchSSAW({ q, brand, color, pageSize }) {
      const url = new URL(CONFIG.ENDPOINTS.ssaw, 'https://upgraded-palm-tree-sepia.vercel.app/');
      if (q) url.searchParams.set('q', q);
      if (brand) url.searchParams.set('brand', brand);
      if (color) url.searchParams.set('color', color);
      if (pageSize) url.searchParams.set('pageSize', pageSize);

      const t0 = performance.now();
      const res = await fetch(url, { mode: 'cors' });
      const t1 = performance.now();
      if (!res.ok) throw new Error(`SSAW HTTP ${res.status}`);
      const data = await res.json();

      // Expect either { products: [...] } or an array
      const list = Array.isArray(data) ? data : (data.products ?? data.items ?? []);
      // Map to unified shape
      const out = list.map(p => ({
        _source: 'SSAW',
        id: safe(p, 'id', 'ID', 'styleId', 'StyleID', 'styleNumber', 'style', 'StyleNumber') ?? crypto.randomUUID(),
        name: safe(p, 'name', 'productName', 'styleName', 'StyleName') ?? 'Unnamed',
        brand: safe(p, 'brand', 'brandName', 'BrandName') ?? '—',
        style: safe(p, 'style', 'styleNumber', 'StyleNumber', 'styleCode', 'StyleCode') ?? '—',
        color: safe(p, 'color', 'colorName', 'ColorName') ?? '—',
        price: safe(p, 'price', 'sellPrice', 'SellPrice', 'customerPrice', 'CustomerPrice'),
        image: imgOrPlaceholder(safe(p, 'image', 'imageUrl', 'ImageUrl', 'frontImage', 'FrontImage')),
        qty: pickQty(p),
        _raw: p,
      }));

      return { items: out, ms: Math.round(t1 - t0), count: out.length };
    }

    // --- Provider: SanMar (SOAP via your proxy) -----------------------------
    async function searchSanmar({ q, brand, color, pageSize }) {
      const url = new URL(CONFIG.ENDPOINTS.sanmar, CONFIG.BASE_URL);
      if (q) url.searchParams.set('q', q);          // your proxy maps this to <Keywords>
      if (brand) url.searchParams.set('brand', brand); // → <BrandName>
      if (color) url.searchParams.set('color', color); // → <ColorName>
      if (pageSize) url.searchParams.set('pageSize', pageSize);

      const t0 = performance.now();
      const res = await fetch(url, { mode: 'cors' });
      const t1 = performance.now();
      if (!res.ok) throw new Error(`SanMar HTTP ${res.status}`);
      const data = await res.json();

      // Expect either { products: [...] } or array
      const list = Array.isArray(data) ? data : (data.products ?? data.items ?? []);
      const out = list.map(p => ({
        _source: 'SanMar',
        id: safe(p, 'StyleNumber', 'styleNumber', 'id') ?? crypto.randomUUID(),
        name: safe(p, 'StyleName', 'styleName', 'name') ?? 'Unnamed',
        brand: safe(p, 'BrandName', 'brandName', 'brand') ?? '—',
        style: safe(p, 'StyleNumber', 'styleNumber') ?? '—',
        color: safe(p, 'ColorName', 'colorName', 'color') ?? '—',
        price: safe(p, 'SellPrice', 'sellPrice', 'Price', 'price'),
        image: imgOrPlaceholder(safe(p, 'ImageUrl', 'imageUrl', 'image')),
        qty: pickQty(p),
        _raw: p,
      }));

      return { items: out, ms: Math.round(t1 - t0), count: out.length };
    }

    // --- Render helpers ------------------------------------------------------
    function setStatus(el, { title, status, ms, count, ok }) {
      el.className = `rounded-xl border p-3 text-sm ${ok ? 'border-slate-200 bg-white' : 'border-red-200 bg-red-50'}`;
      el.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="font-medium">${title}</div>
          <div class="text-xs text-slate-500">${ms ?? '—'} ms</div>
        </div>
        <div class="mt-1">${status}</div>
        <div class="mt-1 text-xs text-slate-500">${Number.isFinite(count) ? count : '—'} results</div>`;
    }

    function cardFor(item) {
      const tpl = document.querySelector('#card-tpl');
      const node = tpl.content.firstElementChild.cloneNode(true);
      node.querySelector('img').src = item.image;
      node.querySelector('[data-source]').textContent = item._source;
      node.querySelector('[data-style]').textContent = item.style ?? '—';
      node.querySelector('[data-name]').textContent = item.name ?? '—';
      node.querySelector('[data-brand]').textContent = item.brand ?? '—';
      node.querySelector('[data-qty]').textContent = fmtInt(item.qty);
      node.querySelector('[data-color]').textContent = item.color ?? '—';
      node.querySelector('[data-price]').textContent = (item.price != null ? `$${Number(item.price).toFixed(2)}` : '—');
      node.querySelector('[data-id]').textContent = item.id ?? '—';
      node.querySelector('[data-debug]').textContent = JSON.stringify(item._raw, null, 2);

      const details = node.querySelector('[data-details]');
      node.querySelector('[data-toggle]').addEventListener('click', (e) => {
        e.stopPropagation();
        details.classList.toggle('open');
      });

      return node;
    }

    function render(items) {
      elResults.innerHTML = '';
      if (!items.length) {
        elEmpty.classList.remove('hidden');
        return;
      }
      elEmpty.classList.add('hidden');
      const frag = document.createDocumentFragment();
      for (const it of items) frag.appendChild(cardFor(it));
      elResults.appendChild(frag);
    }

    // --- Search orchestration ------------------------------------------------
    async function doSearch() {
      const q = elQ.value.trim();
      const brand = elBrand.value.trim();
      const color = elColor.value.trim();
      if (!q && !brand && !color) {
        render([]); // empty state
        setStatus(elStatusSummary, { title: 'Summary', status: 'Idle. Enter a query to search.', ok: true });
        if (elStatusSSAW) setStatus(elStatusSSAW, { title: 'SS Activewear', status: '—', ok: true });
        if (elStatusSanmar) setStatus(elStatusSanmar, { title: 'SanMar', status: '—', ok: true });
        return;
      }

      const wantsSSAW = elChkSSAW.checked;
      const wantsSanmar = elChkSanmar.checked;
      const tasks = [];

      if (wantsSSAW) {
        tasks.push(
          searchSSAW({ q, brand, color, pageSize: CONFIG.PAGE_SIZE })
            .then(r => ({ ok: true, ...r }))
            .catch(err => ({ ok: false, error: String(err) }))
            .then(r => {
              setStatus(elStatusSSAW, { title: 'SS Activewear', status: r.ok ? 'OK' : r.error, ms: r.ms, count: r.count, ok: r.ok });
              return r.ok ? r.items : [];
            })
        );
      }

      if (wantsSanmar) {
        tasks.push(
          searchSanmar({ q, brand, color, pageSize: CONFIG.PAGE_SIZE })
            .then(r => ({ ok: true, ...r }))
            .catch(err => ({ ok: false, error: String(err) }))
            .then(r => {
              setStatus(elStatusSanmar, { title: 'SanMar', status: r.ok ? 'OK' : r.error, ms: r.ms, count: r.count, ok: r.ok });
              return r.ok ? r.items : [];
            })
        );
      }

      const results = (await Promise.all(tasks)).flat();
      // Simple sort: show in-stock first, then by brand/name
      results.sort((a, b) => (Number(b.qty||0) - Number(a.qty||0)) || String(a.brand).localeCompare(String(b.brand)) || String(a.name).localeCompare(String(b.name)) );
      render(results);
      setStatus(elStatusSummary, { title: 'Summary', status: `Combined results from ${wantsSSAW && wantsSanmar ? 'both providers' : wantsSSAW ? 'SSAW' : 'SanMar'}.`, ms: undefined, count: results.length, ok: true });
    }

    // --- Events --------------------------------------------------------------
    elQ.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') doSearch();
    });
    [elBrand, elColor].forEach(el => el.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); }));
    elChkSSAW.addEventListener('change', doSearch);
    elChkSanmar.addEventListener('change', doSearch);

    // Kick off with empty state hint
    render([]);
    setStatus(elStatusSummary, { title: 'Summary', status: 'Idle. Enter a query to search.', ok: true });
    if (elStatusSSAW) setStatus(elStatusSSAW, { title: 'SS Activewear', status: '—', ok: true });
    if (elStatusSanmar) setStatus(elStatusSanmar, { title: 'SanMar', status: '—', ok: true });

    // Expose for quick console testing
    window.__ANTON__ = { doSearch, CONFIG };
  </script>
</body>
</html>
